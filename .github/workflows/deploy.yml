name: Deploy Crawl4AI (private)

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: "GCP Project ID"
        required: true
      region:
        description: "Cloud Run region"
        required: true
        default: "us-central1"
      service:
        description: "Cloud Run service name"
        required: true
        default: "crawl4ai-api"
      port:
        description: "Container port"
        required: true
        default: "11235"
      invokers:
        description: "Identit√©s autoris√©es √† appeler (s√©par√©es par virgule ou retour ligne). Ex: serviceAccount:n8n-invoker@PROJET.iam.gserviceaccount.com"
        required: false
        default: ""
      runtime_sa:
        description: "Service Account d'ex√©cution Cloud Run (optionnel). Si vide => <PROJECT_NUMBER>-compute@developer.gserviceaccount.com"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDSDK_CORE_PROJECT: ${{ inputs.project_id }}  # √©vite les overrides

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      # üîê Auth avec cl√© JSON de Service Account stock√©e dans le secret GCP_SA_KEY
      - name: Auth to GCP (Service Account key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # üîé R√©soudre le SA runtime (si non fourni, utiliser <PROJECT_NUMBER>-compute@developer.gserviceaccount.com)
      - name: Resolve runtime Service Account
        id: rsaname
        shell: bash
        run: |
          set -e
          PROJECT_ID="${{ inputs.project_id }}"
          WANT="${{ inputs.runtime_sa }}"
          if [[ -n "$WANT" ]]; then
            echo "runtime_sa=$WANT" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          PROJECT_NUMBER="$(gcloud projects describe "$PROJECT_ID" --format='value(projectNumber)')"
          DEFAULT_SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"
          echo "runtime_sa=$DEFAULT_SA" >> "$GITHUB_OUTPUT"

      # üîê Donner au SA d'ex√©cution l'acc√®s au secret GEMINI_API_KEY
      # (si le secret n'existe pas encore, cette √©tape √©chouera : cr√©e-le d'abord ou rends cette √©tape tol√©rante)
      - name: Grant Secret Manager accessor to runtime SA
        shell: bash
        run: |
          set -e
          RUNTIME_SA="${{ steps.rsaname.outputs.runtime_sa }}"
          echo "Granting roles/secretmanager.secretAccessor on GEMINI_API_KEY to $RUNTIME_SA"
          gcloud secrets add-iam-policy-binding GEMINI_API_KEY \
            --member="serviceAccount:${RUNTIME_SA}" \
            --role="roles/secretmanager.secretAccessor" \
            --project="${{ inputs.project_id }}"

      # ‚úÖ D√©ploiement PRIV√â (note: pas de --allow-unauthenticated)
      - name: Deploy to Cloud Run (private)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          project_id: ${{ inputs.project_id }}
          service: ${{ inputs.service }}
          region: ${{ inputs.region }}
          image: docker.io/unclecode/crawl4ai:latest
          flags: >-
            --port=${{ inputs.port }}
            --memory=2Gi
            --cpu=2
            --concurrency=10
            --timeout=900
            --max-instances=50
            --service-account=${{ steps.rsaname.outputs.runtime_sa }}
            --set-secrets=GEMINI_API_KEY=GEMINI_API_KEY:latest

      # üßπ S‚Äôassurer que l‚Äôacc√®s public est bien retir√© (ignore l‚Äôerreur si d√©j√† priv√©)
      - name: Ensure service is private (remove public invoker)
        run: |
          set -e
          gcloud run services remove-iam-policy-binding "${{ inputs.service }}" \
            --region="${{ inputs.region }}" \
            --project="${{ inputs.project_id }}" \
            --member="allUsers" \
            --role="roles/run.invoker" || true

      # üé´ Donner le badge "run.invoker" aux identit√©s que TU choisis (facultatif)
      - name: Grant run.invoker to allowed callers
        if: ${{ inputs.invokers != '' }}
        run: |
          set -e
          IFS=$'\n,' read -r -a MEMBERS <<< "${{ inputs.invokers }}"
          for m in "${MEMBERS[@]}"; do
            M=$(echo "$m" | xargs)    # trim
            [[ -z "$M" ]] && continue
            if [[ "$M" != *":"* ]]; then
              M="serviceAccount:${M}"
            fi
            echo "Granting roles/run.invoker to $M"
            gcloud run services add-iam-policy-binding "${{ inputs.service }}" \
              --region="${{ inputs.region }}" \
              --project="${{ inputs.project_id }}" \
              --member="$M" \
              --role="roles/run.invoker"
          done

      # üîó Afficher l‚ÄôURL (elle demandera un ID token, normal : service priv√©)
      - name: Show URL
        run: |
          URL=$(gcloud run services describe "${{ inputs.service }}" --region="${{ inputs.region }}" --project="${{ inputs.project_id }}" --format='value(status.url)')
          echo "URL (auth requise): ${URL}"
          echo "### ‚úÖ D√©ploiement priv√© r√©ussi" >> $GITHUB_STEP_SUMMARY
          echo "**URL** (auth requise): ${URL}" >> $GITHUB_STEP_SUMMARY
